<div class="page-header">
  <div class="header-content">
    <div>
      <h1>Student Reports</h1>
      <p>View, search, filter and export student data from the database.</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button [matMenuTriggerFor]="exportMenu" color="primary" [disabled]="exporting">
        <mat-icon>download</mat-icon>
        {{ exporting ? 'Exporting...' : 'Export' }}
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="export('excel')">
          <mat-icon>table_chart</mat-icon>
          <span>Export to Excel</span>
        </button>
        <button mat-menu-item (click)="export('csv')">
          <mat-icon>description</mat-icon>
          <span>Export to CSV</span>
        </button>
        <button mat-menu-item (click)="export('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>Export to PDF</span>
        </button>
      </mat-menu>
    </div>
  </div>
</div>

<mat-card class="filters-card">
  <mat-card-content>
    <div class="filters-row">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Search by Student ID</mat-label>
        <input matInput [(ngModel)]="searchId" placeholder="Enter student ID" (keyup.enter)="applyFilters()">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Filter by Class</mat-label>
        <mat-select [(ngModel)]="classFilter">
          <mat-option value="">All Classes</mat-option>
          @for (cls of classOptions; track cls) {
            <mat-option [value]="cls">{{ cls }}</mat-option>
          }
        </mat-select>
        <mat-icon matPrefix>school</mat-icon>
      </mat-form-field>

      <div class="filter-actions">
        <button mat-raised-button color="primary" (click)="applyFilters()">
          <mat-icon>filter_list</mat-icon>
          Apply Filters
        </button>
        <button mat-stroked-button (click)="clearFilters()" matTooltip="Clear all filters">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
      </div>
    </div>
  </mat-card-content>
</mat-card>

<mat-card class="table-card">
  <mat-card-content>
    @if (loading) {
      <div class="loading-container">
        <mat-spinner diameter="48"></mat-spinner>
        <div class="timer-inline">
          <mat-icon>timer</mat-icon>
          <span>{{ loadTimerState.formattedTime }}</span>
        </div>
        <p>Loading students...</p>
      </div>
    } @else {
      <div class="table-container">
        <table mat-table [dataSource]="students" class="students-table">
          <!-- Student ID Column -->
          <ng-container matColumnDef="studentId">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let student">
              <span class="id-badge">{{ student.studentId }}</span>
            </td>
          </ng-container>

          <!-- First Name Column -->
          <ng-container matColumnDef="firstName">
            <th mat-header-cell *matHeaderCellDef>First Name</th>
            <td mat-cell *matCellDef="let student">{{ student.firstName }}</td>
          </ng-container>

          <!-- Last Name Column -->
          <ng-container matColumnDef="lastName">
            <th mat-header-cell *matHeaderCellDef>Last Name</th>
            <td mat-cell *matCellDef="let student">{{ student.lastName }}</td>
          </ng-container>

          <!-- DOB Column -->
          <ng-container matColumnDef="dob">
            <th mat-header-cell *matHeaderCellDef>Date of Birth</th>
            <td mat-cell *matCellDef="let student">{{ student.dob }}</td>
          </ng-container>

          <!-- Class Column -->
          <ng-container matColumnDef="studentClass">
            <th mat-header-cell *matHeaderCellDef>Class</th>
            <td mat-cell *matCellDef="let student">
              <span class="class-chip" [attr.data-class]="student.studentClass">
                {{ student.studentClass }}
              </span>
            </td>
          </ng-container>

          <!-- Score Column -->
          <ng-container matColumnDef="score">
            <th mat-header-cell *matHeaderCellDef>Score</th>
            <td mat-cell *matCellDef="let student">
              <span class="score-badge" [class.high]="student.score >= 80" [class.medium]="student.score >= 70 && student.score < 80">
                {{ student.score }}
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

          <!-- No Data Row -->
          <tr class="no-data-row" *matNoDataRow>
            <td [attr.colspan]="displayedColumns.length">
              <div class="no-data">
                <mat-icon>search_off</mat-icon>
                <p>No students found</p>
                <span>Try adjusting your search or filter criteria</span>
              </div>
            </td>
          </tr>
        </table>
      </div>

      <mat-paginator
        [length]="total"
        [pageSize]="size"
        [pageIndex]="page"
        [pageSizeOptions]="[5, 10, 25, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    }
  </mat-card-content>
</mat-card>

<div class="stats-row">
  <mat-card class="stat-card">
    <mat-icon>people</mat-icon>
    <div class="stat-content">
      <span class="stat-value">{{ total | number }}</span>
      <span class="stat-label">Total Records</span>
    </div>
  </mat-card>
  <mat-card class="stat-card">
    <mat-icon>filter_list</mat-icon>
    <div class="stat-content">
      <span class="stat-value">{{ students.length }}</span>
      <span class="stat-label">Showing</span>
    </div>
  </mat-card>
  <mat-card class="stat-card">
    <mat-icon>speed</mat-icon>
    <div class="stat-content">
      <span class="stat-value timer">{{ loadTimerState.isRunning ? loadTimerState.formattedTime : lastLoadTime }}</span>
      <span class="stat-label">Query Time</span>
    </div>
  </mat-card>
</div>

@if (exporting) {
  <div class="export-overlay">
    <div class="export-modal">
      <mat-spinner diameter="48"></mat-spinner>
      <div class="timer-display">
        <mat-icon>timer</mat-icon>
        <span class="timer-value">{{ exportTimerState.formattedTime }}</span>
      </div>
      <p>Generating export file...</p>
    </div>
  </div>
}
